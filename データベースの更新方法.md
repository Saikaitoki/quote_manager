# 月次データベースメンテナンス手順書

Renderのフリープラン（FreeのPostgreSQL）は作成から90日で期限切れとなります。
そのため、以下の手順で定期的にデータベースを入れ替えてください。

---

## 方法A： Render Dashboard画面で行う（推奨）
設定ファイルを書き換えず、画面操作だけで完結する方法です。

1. **古いDBの削除**
   - Renderのダッシュボードで、現在稼働しているデータベース（Type: PostgreSQL）を開く。
   - 「Settings」タブの一番下にある **「Delete Database」** を実行して削除する。

2. **新しいDBの作成**
   - ダッシュボード右上の「New +」→「PostgreSQL」を選択。
   - **Name:** `quote_manager_db_202602` のように適当な名前をつける。
   - **Database:** `quote_manager` （なんでもOK）
   - **User:** `user` （なんでもOK）
   - **Region:** `Singapore` (Japanに近い推奨)
   - **Plan:** `Free` を選択。
   - 「Create Database」をクリック。

3. **URLの取得**
   - 作成されたDBの管理画面で **「Internal Database URL」** の値をコピーする。

4. **Webアプリへの接続設定**
   - ダッシュボードに戻り、Web Service (`quote_manager`) を開く。
   - 「Environment」タブを開く。
   - `DATABASE_URL` という項目の値を、先ほどコピーしたURLに書き換えて「Save Changes」を押す。
   - 自動的に再デプロイが始まります。

---

## 方法B： 設定ファイル (`render.yaml`) を書き換える
コード管理で履歴を残したい場合はこちら。

1. `render.yaml` をテキストエディタで開く。
2. `databases` セクションの名前を変更する。
   ```yaml
   databases:
     - name: quote_manager_db_v2  # ← ここを変更 (例: v2, v3...)
       databaseName: quote_manager_new
       user: quote_manager_user_new
       plan: free
   ```
3. `services` (Web) 側の参照も変更する。
   ```yaml
   services:
     - ...
       envVars:
         - key: DATABASE_URL
           fromDatabase:
             name: quote_manager_db_v2 # ← 上記と同じ名前に変更
   ```
4. GitにコミットしてPushすると、自動的に新しいDBが作成され、古いDBは削除（または切断）されます。

---

## ⚠️ 共通の重要作業：初期セットアップ
データベースが新品になると「テーブル」も何もない空っぽの状態です。
アプリが起動しても「Table not found」でエラーになります。
**切り替えが終わったら、必ず以下のコマンドを Render Shell で実行してください。**

1. Renderダッシュボードで Web Service の **「Shell」** タブを開く。
2. 以下のコマンドを実行して、テーブルを作成する（約1〜2分かかります）。
   ```bash
   bundle exec rails db:migrate
   ```
3. 続けて、マスタデータ（kintoneから）を取り込む。
   アプリ画面を開き、**「kintone から最新を取得」** ボタンを押す。

以上で入れ替え作業は完了です。
